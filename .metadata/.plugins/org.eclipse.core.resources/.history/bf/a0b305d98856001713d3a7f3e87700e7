<cfset show = CreateObject("component",'Projects.CFSiteWithRegForm.Application')>
<cfset show.readSesssionInfo()>	
<!---Intialize values--->
<cfset errorMessages = {}>
<cfloop collection="#form#" item="fields">
	<cfset #StructInsert(errorMessages,fields,"")#>
</cfloop>
<cfset errorFlag = false>



<!---Function validates email fields--->
<cffunction name="validateMail" access="private" output="true" returntype="boolean" >
<cfargument type="string" required="true" name="field" />

	<cfif checkEmptyAndSpaces(field) >
		<cfreturn true>
	<cfelse>
		<cfset fieldValue = StructFind(form,arguments.field)>
		<cfset flag = isValid("email",fieldValue)>
	
		<cfif flag>
			<cfreturn false>
		<cfelse>
			<cfset generateErrors(field ,"Email address is not valid")>
			<cfreturn true>
		</cfif>
	</cfif>
</cffunction>

<!---Generates Erros and populates the structure errorMessages--->
<cffunction name="generateErrors" access="private" output="true" returntype="void" >
	<cfargument type="string" name="field" required="true" >
	<cfargument type="string" name="errorMessage" required="false" default="This field cannot be empty">
	<cfset #StructUpdate(errorMessages,arguments.field,errorMessage)# />	 
	
</cffunction>

<!---Checks for empty fields and removes spaces in inputs--->
<cffunction name="checkEmptyAndSpaces" access="private" returntype="boolean" output="true" >
	<cfargument type="string" required="true" name="field">
	<cfset fieldValue = #StructFind(form,field)# />
	<cfset temp = ""/>
	<cfloop from=1 to=#Len(fieldValue)# step=1 index="i">
		<cfset unicode = #Asc(mid(fieldValue,i,1))# />
		<cfset letter = #mid(fieldValue,i,1)# />
			
		<cfif unicode NEQ 32 AND unicode NEQ 9>
			<cfset temp = #temp# & letter />
			
		</cfif>
		
	</cfloop>
	
	
	<cfset StructUpdate(form,field,temp) />
	<cfif #Len(temp)# EQ 0>
		<cfset generateErrors(field) />
		<cfreturn true />
	<cfelse>
		<cfreturn false />
	</cfif>	
	
</cffunction>
<!---Login Validation--->
<cfif StructKeyExists(form,"user_email") and StructKeyExists(form,"user_password")>
	<cfquery datasource="Project_DataSource" name="nmLogin" result="rsLogin">
		SELECT uid 
		FROM dbo.Users_Details
		WHERE EmailAddress = '#form.user_email#' AND Password = '#form.user_password#'
	</cfquery>>	
	
	<cfif rsLogin.recordCount EQ 1>
		<cfquery datasource="Project_DataSource">
			UPDATE dbo.Users_Details 
			SET isActive = 1 
			WHERE uid = #nmLogin.uid#
		</cfquery>
		<cflocation url="http://localhost/CF/CFSiteWithRegForm/home.cfm?uid=#nmLogin.uid#" addtoken="false">
			
	<cfelseif StructFind(form,"user_email") NEQ "" AND StructFind(form,"user_password") NEQ "">
		<cfset errorFlag = true>	
	</cfif>
</cfif>
<html>
 <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login</title>
        
        <link href='https://fonts.googleapis.com/css?family=Nunito:400,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="stylesheet/main.css">
       
  </head>


  <body>
	<p id="val"><p>
      <cfform action="login.cfm" method="post">
      
        <h1>Login</h1>
        <cfif errorFlag EQ true><h3 style="color:red;text-align:center;">Invalid Username/Password</h3></cfif>
        <fieldset>
          <label for="email" class="required">Email Address:</label>
		  
		  <cfif StructKeyExists(form,"user_email") and validateMail("user_email")><p class="errors"><cfoutput> #StructFind(errorMessages,"user_email")#</cfoutput></p></cfif>  
          <cfinput type="text" id="email_address" name="user_email" placeholder="Email Address" class="required"/>
           
          <label for="password" class="required">Password:</label>
          <cfif StructKeyExists(form,"user_password") and checkEmptyAndSpaces("user_password") and StructCount(form) NEQ 0><p class="errors"><cfoutput>#StructFind(errorMessages,"user_password")#</cfoutput></p></cfif>
		  <cfinput type="password" id="password" name="user_password" placeholder="Password" class="required">
    
		  <button type="submit" id="submitbttn" >Login</button>
		</fieldset>
      </cfform>
      	 <script src="js/script.js"></script>
    	 <script src="js/login.js"></script>
    		
	</body>
</html>      
          